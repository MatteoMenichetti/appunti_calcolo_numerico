\section{Formule di quadratura numerica (approssimazione di integrali definiti)}
\subsection{Introduzione}
\footnote{Slide 10 PDF 25, 26-27, PG 105-114.} Il problema da risolvere è quello di approssimare il valore dell'integrale nella forma
\begin{equation}\label{eq:problema_quadratura}
    I(f)=\int_{a}^{b}f(x) dx,\quad -\infty<\overset{\footnotemark}{\boldsymbol{a<b}}<\infty ,
\end{equation}
dove $f:[a,b]\rightarrow\mathbb R$, almeno continua.
\footnotetext{Se $a>b$ allora $a$ e $b$ sono invertiti di segno ed è applicato Riemann. }

In questa trattazione di approssimazione di integrali definiti è considerato solo il caso in cui $f\in C^{(0)}[a,b]$, per evitare singolarità integrabili nell'intervallo $[a,b]$ e non sarà considerato il caso di integrali definiti su insiemi illimitati. I metodi di approssimazione trattati saranno definiti mediante l'integrale di un'approssimazione polinomiale a tratti di $f(x)$, in quanto l'integrale di un polinomio può essere calcolato facilmente ed in modo esatto.

Se non è conosciuta la derivata prima di $f$, l'integrale è calcolato in forma chiusa. Spesso è necessario fornire un metodo numerico in questo intervallo. Questi metodi si chiamano "Forma di quadratura" (i quali consentono di determinare l'integrale esatto di una approssimazione della funzione $f$, per la quale è possibile l'integrazione).

Prima di trattare i metodi di approssimazione è studiato il condizionamento del problema dell'integrazione, in cui la perturbazione è sulla funzione integranda $f(x)$. Studiare il condizionamento significa stabilire se al posto di $f$ è presente una sua perturbazione, ovvero quando il risultato è perturbato.

\begin{definition}[Numero di condizionamento]
    Supposta $\Tilde{f}(x)\in C^{(0)}[a,b]$, ovvero una perturbazione di $f(x)$, allora (vedi (\ref{eq:norma_infinito_g})):
    \begin{equation*}
        \begin{matrix}
            \overbrace{\boldsymbol{|I(f)-I(\Tilde{f})|}}^{\footnotemark} &=& \left|\int_{a}^{b}f(x)dx-\int_{a}^{b}\Tilde{f}(x)dx\right| &=& \left|\int_{a}^{b}(f(x)-\Tilde{f}(x))dx\right|\\
             &\underset{\footnotemark}{\leq}&\int_{a}^{b}|f(x)-\Tilde{f}(x)|dx&\leq& ||f-\Tilde{f}||\cdot\int_{a}^{b}dx &=&\boldsymbol{(b-a)\cdot}\boldsymbol{||f-\Tilde{f}||},
        \end{matrix}
    \end{equation*}
    
    \addtocounter{footnote}{-1}
    \footnotetext{Errore del risultato.}
    
    \stepcounter{footnote}
    \footnotetext{Il valore assoluto di un integrale di una funzione è minore uguale dell'integrazione del valore assoluto della funzione. Questo è specificato anche dal criterio di integrabilità.}
    
    \noindent dove
    \begin{enumerate}
    	\item \begin{equation}\label{eq:numero_condizionamento_integrale}
    		\boldsymbol{\kappa=(b-a)},
    	\end{equation} 
    	è il numero condizionamento del problema (\ref{eq:problema_quadratura}),
    	\item $\boldsymbol{||f-\Tilde{f}||}=\underset{a\leq x\leq b}{\max} |f(x)-\Tilde{f}(x)|$ misura l'errore sui dati in ingresso.
    \end{enumerate}
\end{definition}

\subsection{Formule di Newton-Cotes}\label{ssec:formule_N-C}\footnote{Slide 10 PDF 25-26, PG 106-108.}
Le formule più semplici per l'approssimazione di $I(f)$ nell'intervallo $[a,b]$, dette \textbf{formule di Newton-Cotes}, sono ottenute calcolando l'integrale esatto del polinomio interpolante $p_n(x)$ la funzione $f(x)$ su $n+1$ ascisse equidistanti definite come
\begin{equation}\label{eq:condizione_ascisse_equidistanti_newton_cotes}
    \begin{matrix}
        &x_i=a+ih,&\quad i=0,\hdots,n,\\
        &p_n(x_i)=f_i \equiv f(x_i),&\quad h=\frac{b-a}{n}.
    \end{matrix}
\end{equation}

\begin{definition}[Formula di Newton-Cotes]
	Sia $p_n(x)$ il polinomio interpolante $f(x)$ sulle ascisse definite come (\ref{eq:condizione_ascisse_equidistanti_newton_cotes}), è considerata la sua forma di Lagrange (\ref{eq:polinomi_lagrange})-(\ref{eq:formaKronecker}) per l'approssimazione di $I(f)$. La formula di Newton-Cotes di grado $n$ è definita come
	\begin{equation}\label{eq:formula_newton_cotes}
		I(f)\approx I(p_n) = \int_a^b p_n(x)dx=\underbrace{\sum_{i=0}^n f_i\int_a^b L_{in}(x)dx}_{\footnotemark}\equiv I_n(f),
	\end{equation}\footnotetext{Questa è una formulazione ingombrante, cambiando l'intervallo di definizione è necessario ricalcolare gli $f_i$ (ovvero gli $f(x_i)$). Tramite la sommatoria è ottenuta una combinazione lineare dei valori della funzione $f$ pesata dagli integrali (i quali sono integrali del polinomio di Lagrange).}
\end{definition}

\noindent  Poste le seguenti condizioni, per $x=a+th$ e $t\in [0,n]$
\begin{enumerate}
    \item $x_i=a+ih\Rightarrow x_i\rightarrow i,\quad i=0,\hdots ,n$,
    \item $dx=\boldsymbol{h}dt\quad (h=\frac{b-a}{n}$, per (\ref{eq:condizione_ascisse_equidistanti_newton_cotes})),
\end{enumerate}
ed utilizzando la seguente espressione
\begin{equation*}
    \begin{matrix}
        \int_a^b L_{in}(x)dx&\overset{x=a+th}{=}&h\int_0^nL_{in}(a+th)dt&=& h\int_0^n\prod_{j=0,j\neq i}^{n}\frac{\overbrace{(a+th)}^x-\overbrace{(a+jh)}^{x_j}}{\underbrace{(a+ih)}_{x_i}-\underbrace{(a+jh)}_{x_j}}dt\\
        &\overset{\footnotemark}{=}&h\underbrace{\int_0^n\prod_{j=0,j\neq i}^n\frac{t-j}{i-j}dt}_{c_{in}} &\equiv& \frac{b-a}{n}\, c_{in} &=& h\,c_{in}
    \end{matrix}
\end{equation*}
è ottenuta una formulazione più conveniente di (\ref{eq:formula_newton_cotes}), la seguente.
\footnotetext{Semplificando $a$ e raggruppando $h$.}

\begin{definition}[Formula di quadratura di Newton-Cotes (conveniente)]
	La \textbf{formula di Newton-Cotes di grado} $\boldsymbol n$ è esprimibile come:
	\begin{equation}\label{eq:formula_newton_cotes_conveniente}
	    \boldsymbol{I_n(f)\approx h\sum_{i=0}^n f_ic_{in}},\quad \boldsymbol{c_{in}=\int_0^n\prod_{j=0, j\neq i}^n \frac{t-j}{i-j}dt},\quad i=0, \hdots, n.
	\end{equation}
\end{definition}

\begin{property}[Proprietà di $c_{in}$]
	Alcune proprietà dei coefficienti $\{c_{in}\}_{i\in\{0, \hdots,n\}}$ sono le seguenti:
	\begin{enumerate}
	    \item \footnotemark Dalla simmetria delle ascisse $\{x_i\}$ nell'intervallo $[a,b]$ segue che:
	    \begin{equation}\label{eq:coefficienti_simmetrici_formula_newton_cotes}
	        \boldsymbol{c_{in}=c_{i,n-i},\quad i=0,\hdots,n.}
	    \end{equation}
	    \footnotetext{Slide 13 PDF 25, PG 107. Questa proprietà deriva dal fatto che le ascisse di interpolazione sono simmetriche. Affinché la 1. valga è sufficiente che le ascisse siano simmetriche (non è richiesto che siano equidistanti).}
	    \item \footnotemark \begin{equation}\label{eq:coefficienti_formula_newton_cotes_uguale_1}
	        \boldsymbol{\frac{1}{n}\sum_{i=0}^{n}c_{in}=1},
	    \end{equation}
	    ovvero
	    \begin{equation*}
	    	\sum_{i=0}^{n}c_{in} = n.
	    \end{equation*}
	    \footnotetext{Slide 13 PDF 25, Teorema 5.1 PG 106.}
	    \begin{proof}[Dimostrazione 2.]
	        Se considerato $\boldsymbol{a=0},\, \boldsymbol{b=1}$ e $\boldsymbol{f(x)\equiv1}$ segue che, poiché $p(x)\equiv f(x)\equiv 1:$
	        \begin{equation*}
	            \int_0^1 1\cdot dx=1\equiv I_n(1)=\frac{1}{n}\sum_{i=0}^n1\cdot 	c_{in}=\frac{1}{n}\sum_{i=0}^nc_{in}.\quad\footnotemark
	        \end{equation*}
	        \footnotetext{Se $n=1$ sono presenti due coefficienti e non è necessario calcolarli perché è noto che siano uguali (la somma $c$ vale $\frac{1}{2}$). Se $n=2$ sono presenti tre coefficienti, è calcolato il primo (il quale è uguale all'ultimo) e l'altro è ottenuto tramite differenza tra il risultato e i due coefficienti uguali. Il calcolo dei coefficienti è spiegato tra poche righe.}
	    \end{proof}
	    \item \footnote{OSS Slide 6 PDF 26.} Se $n\in\{1,2,\hdots, 7, 9\}$, allora
	    \begin{equation}\label{eq:coefficiente_formula_N-C_GT0}
	    	\boldsymbol{\forall\, i=0,\hdots, n\; :\; c_{in} > 0},
	    \end{equation}
	    \item Se $n=8$ o $n\geq 10$, allora 
	    \begin{equation}\label{eq:coefficiente_formula_N-C_LT0}
	    	c_{in} < 0
	    \end{equation}
	\end{enumerate}
\end{property}

\paragraph{Implementazione coefficienti $\boldsymbol{c_{in}}$:} Vedere l'Algoritmo \ref{alg:coefficienti_newton_cotes}.

\begin{algorithm}
	\caption{Implementazione coefficienti Newton-Cotes.}\label{alg:coefficienti_newton_cotes}
	\begin{lstlisting}[style=Matlab-editor]
		function cin = NCoeff(n)
		%   
		%   cin = NCoeff(n)
		%
		%   Calcola i coefficienti della formula di Newton-Cotes di grado n.
		%
		
		if nargin < 1, error('argomento insufficiente'), end
		
		if n < 0, error('grado non valido'), end
		
		cin = zeros(n+1, 1);
		
		for i = 0 : ceil(n/2)
			cin(i+1) = coeffi(i, n);
			cin (n+1-i) = cin(i+1);
		end
		return
		
		function ci = coeffi(i, n)
		%
		%calcolo i-esimo coefficiente della formula
		%
		
		nn = [0:i-1 i+1:n];
		
		scal = prod(i - nn);
		
		a = poly(nn);
		
		nn = (n+1) : -1 : 1;
		
		a = [a./nn 0];
		
		ci = polyva(a, n)/scal;
		
		return
	\end{lstlisting}
\end{algorithm}

\textbf{Utilizzando (\ref{eq:formula_newton_cotes_conveniente})-(\ref{eq:coefficienti_formula_newton_cotes_uguale_1}) sono ottenute le due seguenti formule di quadratura:}
\begin{enumerate}
    \item $\boldsymbol{\underline{n=1}}$: dalle Proprietà (\ref{eq:coefficienti_simmetrici_formula_newton_cotes})-(\ref{eq:coefficienti_formula_newton_cotes_uguale_1}) segue che $c_{01}=c_{11}=\frac{1}{2}$. Pertanto, quando il grado è 1, \textbf{è definita la formula dei trapezi}.
   \begin{definition}[Formula dei trapezi]
   	 \begin{equation}\label{eq:formula_trapezi}
       \boldsymbol{I_1(f)=(b-a)\left(\frac{f(a)+f(b)}{2}\right)}.
    \end{equation}
   \end{definition}
    Tale formula ha un importante significato geometrico (visibile in Figura \ref{fig:grafico_formula_trapezi}), ovvero quello di approssimare, nel caso di funzioni non negative, l'area sottesa dal grafico di $f(x)$ con quella del trapezio avente come vertici i punti $(a,0),(a,f(a)),(b,f(b)),(b,0)$.
    \item $\boldsymbol{\underline{n=2}}$: In questo caso sono presenti 3 coefficienti, ovvero $c_{02},\, c_{12}, \,c_{22},$ t.c.:
    \begin{enumerate}
        \item[P1:] $c_{02}+c_{12}+c_{22}=2$;
        \item[P2:] $c_{02}=c_{22}$ (per la sommatoria).
    \end{enumerate}
    Quindi è necessario calcolare solo $c_{22}$, e non tre. Tale elemento è calcolabile come segue:
    \begin{equation*}
        \begin{matrix}
            \boldsymbol{c_{22}}&=&\int_0^2\frac{t}{2}\frac{t-1}{1}dt&=&\frac{1}{2}\int_0^2(t^2-t)dt&=&\\
            &&\frac{1}{2}\left[\frac{t^3}{3}-\frac{t^2}{2}\right]_0^2&=&\frac{1}{2}\left(\frac{8}{3}-2\right)&=&\boldsymbol{\frac{1}{3}}.
        \end{matrix}
    \end{equation*}
    Dato che $c_{02}=c_{22}=\frac{1}{3}$ allora $c_{12}=2-\frac{2}{3}=\frac{4}{3}$.
    Pertanto, date $x_0=a, x_1=\frac{a+b}{2}$ e $x_2=b$ è ottenuta la seguente formula di quadratura:
	\begin{definition}[Formula di quadratura di Simpson]
		    \begin{equation}\label{eq:formula_simpson}
	        \boldsymbol{I_2(f)=\frac{b-a}{6}\left(f(a)+4f\left(\frac{a+b}{2}\right)+f(b)\right)}.
	    \end{equation}
	\end{definition}
\end{enumerate}

\begin{figure}
    \centering
    \includegraphics[width=0.5\textwidth]{immagini/grafFormTrapezi.png}
    \caption{Esempio del metodo dei trapezi ($f(a)$, $b-a$ ed $f(b)$ sono lunghezze).}\label{fig:grafico_formula_trapezi}
\end{figure}

\subsubsection{Condizionamento di una formula di Newton-Cotes}
\footnote{Slide 5-6 PDF 26, PG 108.}
Data una perturbazione $\Tilde{f}(x)$ di $f(x)$ è possibile studiare come $\Tilde{f}(x)$ influisca sulla differenza fra $I_n(f)$ e $I_n(\Tilde{f})$, quindi è studiato il condizionamento del calcolo della formula di Newton-Cotes (\ref{eq:formula_newton_cotes_conveniente}). In analogia con quanto visto per il condizionamento di (\ref{eq:problema_quadratura}), è ottenuta la seguente definizione.

\begin{definition}[Condizionamento formula di Newton-Cotes]
	Sia $\tilde{f}(x)$, perturbazione della funzione $f(x)$, allora
	\begin{equation*}
	    \begin{matrix}
		        |I_n(f)-I_n(\Tilde{f})|&\overset{\footnotemark}{=}&h|\sum_{i=0}^n c_{in}f_i-\sum_{i=0}^n c_{in}\Tilde{f_i}|&=&\\
		        h|\sum_{i=0}^n c_{in}(f_i-\Tilde{f_i})|&\overset{\footnotemark}{\leq}&h\sum_{i=0}^n |c_{in}(f_i-\Tilde{f_i})|&=&\\
		        h\sum_{i=0}^n |c_{in}|\cdot|f_i-\Tilde{f_i}|&\leq&(h\sum_{i=0}^n|c_{in}|)\underset{i=0,\hdots,n}{\max}|f_i-\Tilde{f_i}|&\leq&\\
		        &&(h\sum_{i=0}^n|c_{in}|)\cdot ||f-\Tilde{f}||,
	    \end{matrix}
	\end{equation*}
	dove
	\begin{itemize}
		\item \begin{equation}\label{eq:numero_condizionamento_newton_cotes}
			\boldsymbol{\kappa_n = h\sum_{i=0}^n|c_{in}|}
		\end{equation}
		è il \textbf{numero di condizionamento della formula di Newton-Cotes},
		\item \begin{equation*}
			\boldsymbol{||f-\Tilde{f}|| = \underset{a\leq x\leq b}{\max}||f(x)-\Tilde{f}(x)||}
		\end{equation*}
		misura l'\textbf{errore in ingresso},
		\item $h=\frac{b-a}{n}$,
		\item
		\begin{equation*}
			\begin{matrix}
				f_i = f(x_i), & \tilde{f}_i = \tilde{f}(x_i),\\ x_i = a + i\cdot h, &i = 0,\hdots, n.
			\end{matrix}
		\end{equation*}
	\end{itemize}
\end{definition}
\addtocounter{footnote}{-1}
\footnotetext{Supposto di aver trasformato il problema in modo tale che $b>a$.}

\stepcounter{footnote}
\footnotetext{Diseguaglianza triangolare.}

\begin{remark}\label{rem:uguaglianza_numero_condizionamento_newton_cotes}
    Data le Proprietà (\ref{eq:coefficienti_formula_newton_cotes_uguale_1})-(\ref{eq:coefficiente_formula_N-C_GT0}), allora
    \begin{equation}\label{eq:numero_condizionamento_N-C_uguaglianza}
     \boldsymbol{\kappa_n}=\frac{b-a}{n}\sum_{i=0}^n|c_{in}|\overset{\footnotemark}{=}\frac{b-a}{\cancel{n}}\cancel{\sum_{i=0}^nc_{in}}\overset{\footnotemark}{=}b-a\boldsymbol{\equiv\kappa}.
    \end{equation}
\end{remark}
\addtocounter{footnote}{-1}
\footnotetext{Eliminato il modulo perché $c_{in}\geq 0$.}

\stepcounter{footnote}
\footnotetext{Per (\ref{eq:coefficienti_formula_newton_cotes_uguale_1}) ci sono le eliminazioni.}

\paragraph{N.B.:} Se è valida l'Osservazione \ref{rem:uguaglianza_numero_condizionamento_newton_cotes}, ovvero i coefficienti della formula di Newton-Cotes sono non negativi, allora il numero di condizionamento della formula di Newton Cotes (\ref{eq:numero_condizionamento_newton_cotes}) coincide con quello del problema continuo $I(f)$ (\ref{eq:numero_condizionamento_integrale}).

Questo non significa che è ben condizionato: se l'integrale è ben condizionato allora lo è anche la funzione, se l'integrale è mal condizionato lo è anche la funzione. Ciò può essere riformulato affermando che \textbf{il mal condizionamento coincide con quello del problema continuo} (l'integrale $I(f)$).

\begin{remark}
	Se vale la Proprietà (\ref{eq:coefficiente_formula_N-C_LT0}), compaiono pesi negativi nella formula di Newton-Cotes allora 
	\begin{equation*}
		\kappa_n> b-a
	\end{equation*}
	ed il rapporto \begin{equation*}
		\frac{\kappa_n}{\kappa}=\frac{1}{n}\sum_{i=0}^n|c_{in}| \gg 1,
	\end{equation*}
	ovvero cresce molto rapidamente al crescere di $n$. Pertanto, non è raccomandabile l'utilizzo di formule di Newton-Cotes di grado 8 o, genericamente, maggiori uguali a 10 (vedere Figura \ref{fig:knN-C}).
\end{remark}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\textwidth]{immagini/knN-C.png}
    \caption{Numero di condizionamento (\ref{eq:numero_condizionamento_newton_cotes}) delle formule di Newton-Cotes per $n=0,\hdots, 20$.}\label{fig:knN-C}
\end{figure}

\subsection{Errore (di quadratura) e formule composite}
\subsubsection{Errore di quadratura}
\footnote{Slide 8 PDF 26 PG 108.} Discutere l'accuratezza di $I_n(f)$ significa quantificare l'errore di quadratura.
\begin{definition}[Errore di quadratura formula di Newton-Cotes]
	Sia $f\in C^{(n+\mu)}[a,b]$, l'errore di quadratura 
	\begin{equation}\label{eq:errore_quadratura}
	    \begin{matrix}
	        \boldsymbol{E_n(f)}&\boldsymbol{\equiv}& I(f)-I_n(f)&=&\int_a^b f(x)dx-\int_a^bp_n(x)dx\\
	        &=&\int_a^b\underbrace{(f(x)-p_n(x))}_{\footnotemark}dx&=&\int_a^bf[x_0,\hdots,x_n,x]\omega_{n+1}(x)dx\\
	        &&\int_a^bf[x_0,\hdots,x_n,x]\prod_{i=0}^n(x-x_i)dx&\overset{\footnotemark}{=}&\boldsymbol{\nu_n \frac{f^{(n+\mu)}(\xi)}{(n+\nu)!}\left(\frac{b-a}{n}\right)^{n+\mu+1}},\quad\xi\in [a,b],
	    \end{matrix}
	\end{equation}
	\noindent dove:
	\begin{itemize}
		\item $\boldsymbol{\nu_n}$ è una costante che dipende solo da $n$ (ed è limitata uniformemente);
		\item $\boldsymbol{\mu}=
		\begin{cases}
			\boldsymbol 1, &\text{\textbf{se} $\boldsymbol n$ è \textbf{dispari};}\\
			\boldsymbol 2, &\text{\textbf{se} $\boldsymbol n$ è \textbf{pari}.}
		\end{cases}$
	\end{itemize}
\end{definition}
\addtocounter{footnote}{-1}
\footnotetext{Errore di interpolazione.}

\stepcounter{footnote}
\footnotetext{L'errore ha una struttura che nel caso $n$ sia dispari è facile da dimostrare, non è così per $n$ pari.}

\paragraph{N.B.:}
\begin{itemize}
	\item Se $n$ è dispari, è calcolata la derivata $n+1$ (dove 1 è $\mu$). Quindi la formula è esatta se è un polinomio di grado $n$, quando $n$ è dispari. Questo fatto è noto perché il polinomio di grado $n$ interpolante la funzione, la quale è un polinomio di grado $n$, coincide con la funzione stessa.
	\item Se $n$ è pari, l'intergrale è esatto per i polinomi di grado $n+1$ e la derivata $f^{(n+\mu)}(\xi)$, con $m=2\rightarrow n+2$, si annulla se $f$ è un polinomio di grado $n+1$.
\end{itemize}
Quanto appena descritto è l'osservazione seguente.

\begin{remark}
    \footnote{Slide 10 PDF 26, Corollario 5.1 PG 110.} Una formula di Newton-Cotes di grado $n$, calcolata su $n+1$ punti, è esatta per integrandi polinomiali (polonomi) fino al grado:
    \begin{equation*}
        \begin{cases}
            n, &\text{se $n$ dispari};\\
            n+1, &\text{se $n$ pari}.
        \end{cases}
    \end{equation*}
\end{remark}

\subsubsection{Formula dei trapezi composita}
Dato $E_n(f)$ in forma (\ref{eq:errore_quadratura}) non è possibile affermare che $\left(\frac{b-a}{n}\right)^{n+\mu +1}\rightarrow 0,$ per $ n\rightarrow\infty$, a causa del condizionamento del problema. Per risolvere questo problema è necessario decrementare il rapporto $\frac{b-a}{n}$ senza fare crescere $n$ ed è utilizzato un approccio simile a quello delle spline nel caso di interpolazione, ovvero: l'intervallo $[a,b]$ è suddiviso in più sottointervalli di uguale ampiezza ed è utilizzata, su ciascun intervallo, la formula di Newton-Cotes di grado $k$ fissato. Così facendo sono ottenute le formule di Newton-Cotes composite.
Con altre parole l'idea è la seguente: date le ascisse è applicato su ciascun sottointervallo una formula di grado $k$ fissato. Con il numero di questi sottointervalli che tende all'infinito allora, la formula di grado $k$ viene applicata su intervalli sempre più piccoli. Ciò significa che il termine $\frac{b-a}{n}$ si trasformerà in $\left(\frac{b-a}{k}\right)^n$, dove $k$ è il grado della formula ed $n$ il numero di punti.
\begin{definition}[\textbf{Formula dei trapezi composita}]\footnote{Slide 11 PDF 26.}
    Siano $\{x_i\}$ ascisse equidistanziate in $[a,b]$ definite come in (\ref{eq:condizione_ascisse_equidistanti_newton_cotes}), è ottenuta la \textbf{formula dei trapezi composita}:
    \begin{equation}\label{eq:formTrapComp}
        \begin{matrix}
            \boldsymbol{I(f)}&=&\int_a^b f(x) dx &\overset{\footnotemark}{=}&\sum_{i=1}^n\int_{x_{i-1}}^{x_i} f(x)dx\\
            &\approx& h\sum_{i=2}^n\frac{f(x_{i-1})+f(x_i)}{2} &=& h\left(\frac{f_0}{2}+\frac{f_1}{2}+\frac{f_1}{2}+\hdots +\frac{f_{n-1}}{2}+\frac{f_{n-1}}{2}+\frac{f_n}{2}\right)\\
            &\boldsymbol =&\boldsymbol{h\left(\frac{f_0}{2}+\sum_{i=1}^{n-1}f_i+\frac{f_n}{2}\right)} &\boldsymbol\equiv& \boldsymbol{I_1^{(n)}(f)} &\equiv& I_{1n}(f)
        \end{matrix}
    \end{equation}
\end{definition}

\footnotetext{L'intervallo $[a, b]$ è diviso in sottointervalli e quindi l'integrale sull'intervallo, rappresentante l'area totale, è la somma delle aree parziali del sottografo, le quali sono approssimate con le funzioni trapezi.}

\begin{remark}
    \footnote{Slide 12 PDF 26.} Se $f(x)$ è periodica allora $f_n=f_0$ e
    \begin{equation}\label{eq:formula_trapezi_composita_periodica}
    	I_1^{(n)}(f)=h \sum_{i=0}^{n-1}f_i.
    \end{equation}
\end{remark}

\paragraph{Nota sulla computabilità di (\ref{eq:formula_trapezi_composita_periodica}):} La complesità del calcolo della sommatoria è $\log (n)$ perché sommando 2 a 2 i risultati sommati 2 a 2 è possibile arrivare ad un'approssimazione in $\log (n)$ passi. Se la funzione è periodica allora è possibile approssimarla con $\sin$ e $\cos$, per le quali l'approssimazione diviene esatta, per polinomi parametrici di grado sempre più elevato, man mano che cresce $n$. Ciò significa che è possibile ottenere delle approssimazioni molto accurate di un segnale periodico (con $\sin$ e $\cos$).

\paragraph{Implementazione formula trapezi:} Vedere l'Algoritmo \ref{alg:trapec}.

\begin{definition}[\textbf{Errore di quadratura formula dei trapezi composita}]
    L'\textbf{errore commesso} dalla \textbf{formula dei trapezi} è il seguente:
    \begin{equation}\label{eq:errore_formula_trapezi_composita}
        \begin{matrix}
            E_1^{(n)}(f) &\overset{\footnotemark}{=}& I(f)-I_1^{(n)}(f)\\
            &\overset{\footnotemark}{=}&\nu_1 \left(\frac{b-a}{n}\right)^3 \sum_{i=1}^n f^{(2)}(\xi_i),\quad \xi_i\in[x_{i-1},x_i]\\
            &=&\boldsymbol{\nu_1 \left(\frac{b-a}{n}\right)^{3} n  f^{(2)}(\xi)},\quad \xi\in[a,b] \\
            &=& \nu_1 (b-a)f^{(2)}(\xi)\,\left(\frac{b-a}{n}\right)^2.
        \end{matrix}
    \end{equation}
    dove $\nu_1=-\frac{1}{12}$ (non specificato a lezione).
\end{definition}

\begin{remark}
	\begin{equation*}
		E_1^{(n)}(f)\underset{n\rightarrow\infty}{\longrightarrow} 0
	\end{equation*}
\end{remark}
\addtocounter{footnote}{-1}
\footnotetext{Somma di $\sum_{i=1}^n \int_{x_{i-1}}^{x_i} f(x)dx$ e $h\sum_{i=2}^n\frac{f(x_{i-1})+f(x_i)}{2}$.}

\stepcounter{footnote}
\footnotetext{Come in seguito, vale il teorema della sommazione discreta, ovvero: data la derivata seconda continua $f^{(2)}$ (successiva all'uguale nella sommatoria) e sommando $n$ valori che appartengono ad $n$ sottointervalli contigui allora $f^{(2)}$ sarà uguale ad $n$ volte il valore della derivata seconda in un parametro dell'intervallo. Inoltre, $\nu_1=-\frac{1}{12}$, cosa non specificata a lezione. La scelta di $\nu_1$ viene fatta risolvendo un sistema di equazioni che impone che l'errore di quadratura sia nullo per funzioni polinomiali di grado $0$ e $1$. In questo caso, è possibile arrivare alla conclusione che $\nu_1=-\frac{1}{12}$ è la scelta giusta per garantire la convergenza di ordine $O\left((b-a)^3\right)$.}

\begin{algorithm}
	\caption{Implementazione formula dei trapezi composta.}\label{alg:trapec}
	\begin{lstlisting}[style=Matlab-editor]
		function If = trapec(fun, a, b, n)
		%   
		%   If = trapec(fun, a, b, n)
		%
		%   Approssimazione di un integrale definito mediante la formula composita dei trapezi.
		%
		%  Input:
		%   fun - identificatore function funzione intreganda (deve accettare input vettoriali);
		%   a,b - estremi dell'intervallo di integrazione;
		%   n   - numero sottointervallli (default=1).
		%  Output:
		%   If - stima ottenuta.
		%
		if nargin < 3, error('numero argomenti insufficiente')
		elseif nargin == 3, n = 1;
		elseif n <= 0 || n~= fix(n), error('numero di sottointervalli non valido')
		end
		x = linspace(a, b, n+1);
		
		h = (b-a)/n;
		
		f = feval(fun, x); %alternativa (eliminando precedente calcolo di x): f = feval(fun, (0:n)*h);
		
		If = h * (f(1) + 2 * sum(f) + f(n+1))/2);
		
		return
		end
	\end{lstlisting}
\end{algorithm}

\subsubsection{Formula di Simpson composita}
\begin{definition}[\textbf{Formula di Simpson composita}]
    Siano $\{x_i\}$ ascisse equidistanziate definite come in (\ref{eq:condizione_ascisse_equidistanti_newton_cotes}) e dato $\boldsymbol n$ \textbf{pari}, la \textbf{formula di Simpson composita} è
    \begin{equation}\label{eq:formSimpComp}
        \begin{matrix}
            \boldsymbol{I(f)}&=&\int_a^bf(x)dx\\
            &=&\sum_{i=1}^{\frac{n}{2}}\int_{x_{2(i-1)}}^{x_{2i}}f(x)dx\\
            &\overset{\footnotemark}{\approx}&\frac{b-a}{3\cdot n}\sum_{i=1}^{\frac{n}{2}}(f(x_{2(i-1)})+4f(x_{2i-1})+f(x_{2i}))\\
            &\underset{\footnotemark}{=}&\frac{b-a}{3n}(\underline{f_0+4f_1+f_2}+\underline{f_2+4f_3+f_4}+\hdots+\underline{f_{n-2}+4f_{n-1}+f_n})\\
            &=&\frac{b-a}{3n}\underbrace{\left[4\sum_{i=1}^{\frac{n}{2}}f_{2i-1}+2\sum_{i=0}^{\frac{n}{2}}f_{2i}-f_0-f_n\right]}_{\footnotemark}&\boldsymbol\equiv& \boldsymbol{I_2^{(n)}(f)}.
        \end{matrix}
    \end{equation}
\end{definition}

\addtocounter{footnote}{-2}
\footnotetext{Approssimazione che necessita di 3 ascisse, ovvero da $x_0$ a $x_1$, da $x_2$ a $x_4$ e così via, dove l'ascissa in mezzo è quella pesata con 4.}

\stepcounter{footnote}
\footnotetext{4 è associato ai numeri con indice dispari ($f_1,\, f_3,\hdots,\, f_{n-1})$. Gli elementi con indice pari, tranne il primo e l'ultimo, hanno coefficiente 2 perché appartenenti a due intervalli congiunti.}

\stepcounter{footnote}
\footnotetext{Quando le sommatorie dovranno essere implementate in Matlab sarà necessario sfruttare le capacità di calcolo vettoriale di Matlab. Non sono necessari cicli ma è possibile calcolare una valutazione vettoriale della $f$ su tutte le ascisse per poi pesare le componenti in modo opportuno. Sarà visto un esempio nelle esercitazioni.}

\paragraph{Implementazione Formula di Simpson composita:} Vedere l'Algoritmo \ref{alg:simpson_composita}.

\begin{algorithm}
	\caption{Implementazione formula di quadratura di Simpson composta.}\label{alg:simpson_composita}
	\begin{lstlisting}[style=Matlab-editor]
		function I2 = simpson_composita(fun, a, b, n)
		%   
		%   I2 = simpson_composita(fun, a, b, n)
		%
		%   Approssimazione di un integrale definito mediante la formula composita di Simpson.
		%
		%  Input:
		%   fun - identificatore function funzione intreganda (deve accettare input vettoriali);
		%   a,b - estremi dell'intervallo di integrazione;
		%   n   - numero sottointervallli (default=1).
		%  Output:
		%   I2 - stima ottenuta.
		%
		if nargin < 3, error('numero argomenti insufficiente')
		elseif nargin == 3, n = 1;
		elseif n <= 0 || n/2~= fix(n/2), error('numero di sottointervalli non valido')
		end
		
		x = linspace(a, b, n+1);
		
		h = (b-a)/n;
		
		f = feval(fun, x); %alternativa (eliminando precedente calcolo di x): f = feval(fun, a:h:b);
		
		fodd = sum(f(2 : 2 : end));
		
		feven = sum(f(1 : 2 : end));
		
		I2 = h * (4 * fodd + 2 * feven - f(1) - f(end));
		
		return
		end
	\end{lstlisting}
\end{algorithm}

\begin{definition}[\textbf{Errore di quadratura formula di Simpson}]
    L'\textbf{errore commesso} dalla \textbf{formula di Simpson} è il seguente:
    \begin{equation}\label{eq:errFormSimpComp}
        \boldsymbol{E_2^{(n)}(f)}=I(f)-I_2^{(n)}(f)=\boldsymbol{\nu_2 f^{(4)}(\xi)\left(\frac{b-a}{n}\right)^5} = \nu_2f^{(4)}(\xi)\frac{b-a}{2}\left(\frac{b-a}{n}\right)^{\overset{\footnotemark}{4}}\rightarrow 0,\; n\rightarrow\infty,\quad \xi\in[a,b],
    \end{equation}
    dove $\nu_2 = -\frac{n}{180}$ (cosa non speficiata a lezione).
    \footnotetext{$\frac{n}{2}=\frac{2}{2}+\mu=2+1$, con $n$ numero di termini.}
\end{definition}

\subsubsection{Errore di quadratura con \texorpdfstring{$n$}{n} multiplo di \texorpdfstring{$k$}{k}}
Questa procedura si generalizza per tutte le formule di Newton-Cotes di grado $k\in\{1,\hdots, 7, 9\}$, a patto che $n$ sia un multiplo di $k$, ottenendo la formula di Newton-Cotes di grado $k$.
\begin{definition}
	Sia $f\in C^{(k+\nu)}[a,b]$, allora la formula di Newton-Cotes di grado $k$ con $n$ multiplo di $k$ è
	\begin{equation*}
    	I_k^{(n)}=h\sum_{i=0}^nf_ic_{ik}=h\sum_{i=0}^nf_i\int_0^k\prod_{j=0, j\neq i}^k\frac{t-j}{i-j}.
	\end{equation*}
\end{definition}

\begin{definition}[Errore di quadratura formula di Newton-Cotes di grado $k$]
	\begin{equation}\label{eq:EkComposite}
 E_k^{(n)}(f)=\nu_k\frac{f^{(k+\mu)}(\xi)}{(k+\nu)!}\left(\frac{b-a}{k}\right)\left(\frac{b-a}{n}\right)^{k+\mu}, \quad \xi\in[a,b].
\end{equation}
\end{definition}

\begin{remark}
	$E_k^{(n)}(f)\rightarrow 0,\, n\rightarrow\infty$.
\end{remark}

\paragraph{Spiegazione notazione $\boldsymbol{E_k^{(n)}(f)}$:} $k$ è il grado della formula base, $n$ sono i punti utilizzati sui quali è applicata la formula di quadratura composita. Ciò significa che per far diminuire l'errore è possibile far aumentare $n$ lasciando $k$ fisso.

\begin{example}
    Come esempio, esplicato tramite la Figura \ref{fig:approxIntSinx}, è approssimato tramite la formula composita dei trapezi e con quella di Simpson il seguente integrale:
    \begin{equation}\label{eq:approxIntSinx}
        \int_0^\pi \sin{x}dx\quad (=2).
    \end{equation}
    Dalla Figura \ref{fig:approxIntSinx} è possibile notare che l'approssimazione di Simpson sia migliore di quella dei trapezi perché più precisa.
\end{example}

\begin{figure}
    \centering
    \includegraphics[width=0.5\textwidth]{immagini/approxIntSinx.png}
    \caption{Approssimazione e corrispondenti errori di (\ref{eq:approxIntSinx}).}\label{fig:approxIntSinx}
\end{figure}

L'espressione (\ref{eq:EkComposite}) permette di derivare, \textbf{a costo nullo} (cosa importante), una stima dell'errore di quadratura, $E_k^{(n)}(f)$, nel caso in cui $\boldsymbol n$ \textbf{sia un multiplo pari di} $\boldsymbol k$.

È necessario che $n$ sia un multiplo di $k$, affinché lo sia anche $\frac{n}{2}$, cosicché sia possibile valutare $\boldsymbol{I_k^{(\frac{n}{2})}(f)}$. $\boldsymbol{I_k^{(\frac{n}{2})}(f)}$ è calcolato su ascisse di indice pari ($0,2,4,\hdots$) e la valutazione di $I_k^{(\frac{n}{2})}(f)$ è ottenuta senza ulteriori valutazioni della funzione $f(x)$ perché è possibile utilizzare le valutazioni
\begin{equation*}
    \boldsymbol{f_{2i}\equiv f(x_{2i}),\quad i=0,\hdots,\frac{n}{2}},
\end{equation*}
le quali sono già calcolate per la valutazione di $I_k^{(n)}(f)$. \footnote{Sono calcolate le valutazioni funzionali di $f$ per calcolare $I_n^k(f)$ e utilizzate quelle con indice pari così da calcolare $I_n^k$. Il costo della formula di quadratura è maggiorato in un numero di valutazioni di funzioni con costo nullo.} Pertanto, analogamente a (\ref{eq:errFormSimpComp}), vale:
\begin{equation}\label{eq:errFormSimpCompN/2}
    I(f)-I_k^{(\frac{n}{2})}(f)=\nu_k f^{(n+\mu)}(\into{\widehat\xi}{[a,b]})\frac{b-a}{k}\left(\frac{b-a}{n/2}\right)^{n+\mu}\overset{\footnotemark}{\approx}\nu_k f^{(n+\mu)}(\xi)\frac{b-a}{k}\left(\frac{b-a}{n}\right)^{n+\mu}2^{n+\mu}.
\end{equation}\footnotetext{Fingendo che $\widehat\xi=\xi$ e trasformando $\frac{n}{2}$ in $2^{n+\mu}$ allora è possibile l'approssimazione.}

Sottraendo membro a membro (\ref{eq:EkComposite}) a (\ref{eq:errFormSimpCompN/2}) allora:
\begin{equation*}
    I_k^{(n)}(f)-I_k^{(\frac{n}{2})}\approx\boldsymbol{\nu_kf^{(n+\mu)}(\xi)\frac{b-a}{k}\left(\frac{b-a}{n}\right)^{n+\mu}}(2^{n+\mu}-1)\equiv \left(\boldsymbol{I(f)-I_k^{(n)}(f)}\right)(2^{n+\mu}-1).
\end{equation*}

In altri termini, è possibile ottenere una stima dell'errore di quadratura $E_k^{(n)}(f)$ come:
\begin{equation*}
    \boldsymbol{E_k^{(n)}(f)\approx\frac{I_k^{(n)}(f)-I_k^{(\frac{n}{2})}(f)}{2^{n+\mu}-1}\equiv\widehat E_k^{(n)}(f)}.
\end{equation*}

Applicando quanto scritto all'esempio (\ref{eq:approxIntSinx}) sono derivate le Figure \ref{fig:approxInt}-\ref{fig:tabella_errore_quadratura}.

\begin{figure}
    \centering
    \includegraphics[width=0.5\textwidth]{immagini/approxInt.jpg}
    \caption{Approssimazione $\int_{\frac{1}{2}}^{100}-2x^{-3}\cos(x^{-2})$.}\label{fig:approxInt}
\end{figure}

\begin{figure}
    \centering
    \includegraphics[width=0.5\textwidth]{immagini/tabErrQuad.png}
    \caption{Confronto fra errore di quadratura approssimazione con formula di quadratura dei trapezi e di Simpson.}\label{fig:tabella_errore_quadratura}
\end{figure}

In Figura \ref{fig:approxInt} il numero di condizionamento è 99.5, ovvero l'ampiezza dell'intervallo. Il problema è che nell'estremo inferiore, se $x\rightarrow 0$, allora $x^{-2}$ e $x^{-3}$ diventano molto grandi e $\cos{(x^{-2})}$, per $x\rightarrow 0$, oscilla molto. La parte sinistra del grafico è la parte in cui il grafico inizia ad oscillare molto. La questione importante è che la funzione è liscia poco dopo $10^0$ e oscilla poco prima di $10^0$. Se fosse utilizzata una mesh costante accadrebbe che, per ottenere la tolleranza desiderata, diventerebbero necessari punti molto vicini prima di $10^0$, i quali dovrebbero essere riportati anche nella parte liscia. Il problema posto è quello di definire un approccio adattivo per la definizione delle ascisse di interpolazione in modo adattivo, infatti sui punti laddove la funzione è più variabile saranno inseriti più punti ed invece meno dove la funzione è liscia. Per quanto appena scritto, sono introdotte le funzioni di Newton-Cotes adattive della Sezione \ref{ssec:formule_newton-cotes_adattive}.
In Figura \ref{fig:tabella_errore_quadratura} è possibile notare che tanto più cresce $n$ più l'errore diminuisce e quindi aumenta la precisione. È necessario trattare il fatto che, nell'implementazione di queste formule, le ascisse sono tutte equidistanti. Le ascisse equidistanti sono definite come (\ref{eq:condizione_ascisse_equidistanti_newton_cotes}).

\subsection{Formule di Newton-Cotes adattive}\label{ssec:formule_newton-cotes_adattive}
\footnote{Slide 7-12 PDF 27, PG 111-114.}
Il problema è trovare un metodo per definire le ascisse in base al comportamento della funzione. Dal punto di vista algoritmico è interessante ciò che sarà visto nell'implementazione dei casi più semplici, ovvero dei trapezi e di Simpson, con Matlab, tramite function ricorsive. In ogni caso è sfruttato il fatto che esiste un'espressione asintotica dell'errore quadratico.

\subsubsection{Formula dei trapezi}
In questo caso, con $n=1$, è ottenuto (da (\ref{eq:errore_quadratura}))
\begin{equation}\label{eq:errQuadN=1}
    I(f)-I_1(f)=\nu_1 f^{(2)}(\xi)(b-a)^3\quad \xi\in[a,b],
\end{equation}
ed è ottenuto che, da (\ref{eq:errore_formula_trapezi_composita}), applicando la formula composita su due sottointervalli ($n=2$), ciò che segue:\begin{equation}\label{eq:errQuadN=2}
    I(f)-I_1^{(2)}(f)=\nu_1 f^{(2)}(\xi)(b-a)\left(\frac{b-a}{2}\right)^2,\quad \xi\in [a,b],
\end{equation}
dove $\nu_1=-\frac{1}{12}$

Suppondendo che gli $\xi$ di (\ref{eq:errQuadN=2}) da (\ref{eq:errQuadN=1}) siano simili, sottraendo (\ref{eq:errQuadN=2}) da (\ref{eq:errQuadN=1}) è ottenuto che
\begin{equation*}
    \boldsymbol{I_1^{(2)}(f)-I_1(f)}\approx\nu_1 f^{(2)}(\xi)(b-a)\left(\frac{b-a}{2}\right)^2\underset{\footnotemark}{(4-1)}\equiv \left(\boldsymbol{I(f)-I_1^{(2)}(f)}\right) 3
\end{equation*}
allora
\begin{equation*}
    \boldsymbol{E_1^{(2)}(f)\equiv I(f)-I_1^{(2)}(f)\approx\frac{I_1^{(2)}(f)-I_1(f)}{3}}.
\end{equation*}

\footnotetext{Dovuto a $\left(\frac{b-a}{2}\right)^2$ in (\ref{eq:errQuadN=2}) ed a $(b-a)^3$ in (\ref{eq:errQuadN=1}).}

La procedura adattiva è generata con il prossimo passo: Supponendo di dover calcolare $I(f)$ con una accuratezza $\boldsymbol{tol}$ (parametro prefissato, ovvero scelto dall'utente), se $\left|E_1^{(2)}\leq tol\right|$ è terminata la procedura, altrimenti è riapplicata la stessa procedura sui due sottointervalli $\left[a,\frac{a+b}{2}\right],\, \left[\frac{a+b}{2},b\right]$, con tolleranza $\boldsymbol{tol/2}$.

In questo modo è definito, in modo adattivo, l'insieme dei punti su quali sono applicate le formule base e la sua composita raddoppiata.

Quindi il passo di raffinamento esplicito funziona nel seguente modo: se è soddisfatta l'accuratezza richiesta la procedura si ferma, altrimenti il problema è diviso in 2 sottoproblemi, ai quali è applicato separatamente la stessa procedura con tolleranza dimezzata. Il dimezzamento è applicato affinché la somma degli errori sia sempre piccola. Se questa procedura è applicata ricorsivamente laddove l'errore è maggiore allora questo sarà affinato maggiormente, mentre qualora l'errore soddisfa il requisito di accuratezza la procedura si ferma. Questa procedura definisce adattivamente le ascisse, sulle quali sono definite le formule di quadratura.

\subsubsection{Formula di Simpson}
Similmente, per la formula di Simpson ($n=2$ su $[a,b]$), è ottenuto che:
\begin{equation}\label{eq:stimaErrFormQuadSimpN=2}
    I(f)-I_2(f)=\nu_2 f^{(4)}(\xi)\left(\frac{b-a}{2}\right)^{\overset{\footnotemark}{5}},\quad \xi\in[a,b].
\end{equation}
\footnotetext{$\mu=1$ perché $k$ è pari.}

Se è applicata la formula di Simpson composita con $n=4$ su $[a,b]$, è ottenuto:
\begin{equation}\label{eq:stimaErrFormQuadSimpCompN=4}
    I(f)-I_2^{(4)}(f)=\nu_2 f^{(4)}(\widehat\xi)\frac{b-a}{2}\left(\frac{b-a}{4}\right)^4,\quad \widehat\xi\in[a,b],
\end{equation}
dove in (\ref{eq:stimaErrFormQuadSimpN=2}) e (\ref{eq:stimaErrFormQuadSimpCompN=4}) $\nu_2=-\frac{1}{90}$.

Con $\widehat\xi\approx\xi$ (\ref{eq:stimaErrFormQuadSimpN=2}) diviene
\begin{equation}\label{eq:trasfXiToXi}
    I(f)-I_2(f)\approx\nu_2 f^{(4)}(\widehat\xi)\frac{b-a}{2}\left(\frac{b-a}{4}\right)^4\cdot 16.
\end{equation}

\paragraph{Implementazione formula di quadratura di Simpson adattiva:} Vedere l'Algoritmo \ref{alg:formula_simpson_adattiva}.

\begin{algorithm}\caption{Implementazione algoritmo adattivo di Simpson.}
	\label{alg:formula_simpson_adattiva}
	\begin{lstlisting}[style=Matlab-editor]
		function I2 = adapsimp(f, a, b, tol, fa, fb, f1)
		%
		% Utilizzo:tab I2 = adapsimp(f, a, b, tol) [questa e' un'interfaccia utente, viene invocata la prima volta. fa e fb sono utilizzati per implementare la funzione ricorsivamente, quindi dalla seconda invocazione della function] [In questo e' necessario prevere 3 valutazioni funzionali, non come nelle implementazioni della formula dei trapezi, la quale richiede due valutazioni in input]
		%
		% Input:
		%   f - function handler funzione integranda;
		%   a,b - estremi intervallo di integrazione;
		%   tol - accuratezza richiesta.
		%
		% Output:
		%   I2 - approssimazione ottenuta.
		%
		
		if nargin < 4, error('numero argomenti insufficienti'), end
		
		if tol <= 0, error('tolleranza nulla o minore di 0'), end 
		
		if nargin == 4
		fa = feval(f, a); fb = feval(f, b); f1 = feval(f, (a+b)/2);
		end
		
		h = (b - a)/2;
		
		x1 = (a + b)/2;
		
		x11 = (a + x1)/2; f11 = feval(f, x11);
		
		x12 = (x1 + b)/2; f12 = feval(f, x12);
		
		I1 = h * (fa + 4 * f1 + fb); 
		I2 = (fa + 4 * f11 + 2 * f1 + 4 * f12 + fb) * (h/2);
		
		e = abs(I2-I1)/15; %stima dell'errore
		
		if e > tol
		I2 = adapsim(f, a, x1, tol/2, fa, f1, f11)...
		+ adapsim(f, x1, b, tol/2, f1, fb, f12); 
		end
		return
	\end{lstlisting}
\end{algorithm}

Sottraendo (\ref{eq:trasfXiToXi}) da (\ref{eq:stimaErrFormQuadSimpCompN=4}) è ottenuto
\begin{equation*}
    I_2^{(4)}(f)-I_2(f)\approx\nu_2 f^{(4)}(\widehat\xi)\frac{b-a}{2}\left(\frac{b-a}{4}\right)^4(16-1)\equiv E_2^{(4)}(f)\cdot 15.
\end{equation*}
Da questo risultato è ottenuto che l'errore di quadratura $E_2^{(4)}(f)$ può essere stimato come
\begin{equation}
    \boldsymbol{E_2^{(4)}(f)\approx\underbrace{\frac{I_2^{(4)}(f)-I_2(f)}{15}}_{\text{scalare}}}.
\end{equation}

\footnote{È importante notare, sarà fatto nell'esercitazione, che quando sono replicate le procedure, in modo ricorsivo, come vengono riciclate le valutazioni già calcolate, passandole come parametro, al fine di costruire l'albero ricorsivo.}
Pertanto, è richiesta un'accuratezza $\boldsymbol{tol}$ per il calcolo di $I(f)$: se $\left|E_2^{(4)}(f)\right|\leq tol$ la procedura si arresta, altrimenti riapplicando stessa procedura sui due sottointervalli $\left[a,\frac{a+b}{2}\right]$ e $\left[\frac{a+b}{2},b\right]$, con tolleranza $\boldsymbol{tol/2}$.

Ciò che è importante è notare che il procedimento è adattivo ed automatico. La formula dei trapezi è quella meno accurata. La formula di Simpson ha un ordine di accuratezza che è il quadrato di quello dei trapezi.
Inoltre, osservando $E_1^{(n)}$ e $E_2^{(n)}$ è possibile notare che $E_1^{(n)}$ è quasi il quadrato di $E_2^{(n)}$. Questo deriva dal fatto che $\mu=2$, per la formula di Simpson e $\mu=1$ per la formula dei trapezi.

\begin{remark}
    \footnote{Slide 10 PDF 27.} help \textbf{integral}.
\end{remark}

\begin{figure}
    \centering
    \includegraphics[width=0.5\textwidth]{immagini/simpsonAdatToll=10e-5.png}
    \caption{Simpson adattivo con $\boldsymbol{tol=10e-5}$.}\label{fig:simpsonAdatToll=10e-5}
\end{figure}

\begin{algorithm}\caption{Implementazione algoritmo adattivo dei trapezi.}
\label{alg:formula_trapezi_adattiva}
    \begin{lstlisting}[style=Matlab-editor]
    function I2 = adaptrap(f, a, b, tol, fa, fb)
    %
    % Utilizzo:tab I2 = adaptrap(f, a, b, tol) [questa e' un'interfaccia utente, viene invocata la prima volta. fa e fb sono utilizzati per implementare la funzione ricorsivamente, quindi dalla seconda invocazione della function] [Nel caso della function che implementa la funzione Simpson e' necessario prevere 3 valutazioni funzionali, non come nelle implementazioni della formula dei trapezi, la quale richiede due valutazioni in input]
    %
    % Input:
    %   f - function handler funzione integranda;
    %   a,b - estremi intervallo di integrazione;
    %   tol - accuratezza richiesta.
    %
    % Output:
    %   I2 - approssimazione ottenuta.
    %
    
    if nargin < 4, error('numero argomenti insufficienti'), end
    
    if tol <= 0, error('tolleranza nulla o minore di 0'), end 
    
    if nargin == 4
        fa = feval(f, a); fb = feval(f, b); % evitano valutazioni ridondanti per le chiamate ricorsive di adatrap 
    end
    
    h = b - a;
    
    x1 = (a + b)/2;
    
    f1 = feval(f, x1); %valutazione funzionale nel punto medio
    
    I1 = (h/2)*(fa+fb); 
    I2 = (I1 + h*f1)/2; 
    
    e = abs(I2-I1)/3; %stima dell'errore
    
    if e > tol
        I2 = adaptrap(f, a, x1, tol/2, fa, f1)...
         + adaptrap(f, x1, b, tol/2, f1, fb); 
    end
    return
    \end{lstlisting}
\end{algorithm}
